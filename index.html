<!DOCTYPE html>
<html>
<head>
    <title>Live Voice Streaming</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { display: flex; justify-content: center; align-items: center; height: 100vh; }
        button { padding: 15px 30px; font-size: 18px; cursor: pointer; }
    </style>
</head>
<body>
    <button id="micButton">Start Mic</button>

    <script>
        const params = new URLSearchParams(window.location.search)
        const chatId = params.get('chat_id')
        let isRecording = false
        let mediaRecorder
        let ws

        async function startRecording() {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true })
            const audioContext = new AudioContext()
            const source = audioContext.createMediaStreamSource(stream)
            const processor = audioContext.createScriptProcessor(2048, 1, 1)
            
            source.connect(processor)
            processor.connect(audioContext.destination)
            
            ws = new WebSocket(`wss://142.93.211.253:${WS_PORT}`)
            
            ws.onopen = () => {
                ws.send(chatId)
                processor.onaudioprocess = (e) => {
                    const input = e.inputBuffer.getChannelData(0)
                    const pcm = convertFloat32ToInt16(input)
                    if (ws.readyState === WebSocket.OPEN) {
                        ws.send(pcm)
                    }
                }
            }
        }

        function convertFloat32ToInt16(buffer) {
            const l = buffer.length
            const buf = new Int16Array(l)
            for (let i = 0; i < l; i++) {
                buf[i] = Math.min(1, buffer[i]) * 0x7FFF
            }
            return buf.buffer
        }

        document.getElementById('micButton').addEventListener('click', async () => {
            if (!isRecording) {
                isRecording = true
                document.getElementById('micButton').textContent = 'Stop Mic'
                await startRecording()
            } else {
                isRecording = false
                document.getElementById('micButton').textContent = 'Start Mic'
                if (ws) ws.close()
            }
        })
    </script>
</body>
</html>
